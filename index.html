<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <title>Fokachat</title>    
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="style.css" />                           
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="row" style="gap:10px;flex:1">
        <div id="headerAvatar"></div>
        <div>
          <div class="muted" id="meLine">Conectando‚Ä¶</div>
        </div>
      </div>
      <div>
        <h4 style="margin:0 0 8px">Sincronizar entre navegadores</h4>
        <div class="muted" style="font-size:13px">
          Gere um <b>c√≥digo de transfer√™ncia</b> e cole-o em outro navegador para usar o mesmo ID an√¥nimo.
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" id="genCodeBtn" title="Exportar c√≥digo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l-5 5h3v7h4v-7h3l-5-5zm0 10v10H8v-2h8v2h-4V12z"/></svg>
          </button>
          <button class="btn" id="importCodeBtn" title="Importar c√≥digo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 22l5-5h-3v-7h-4v7H7l5 5zm0-10V2h4v2H8v-2h4v10z"/></svg>
          </button>
          <button class="btn" id="reseedBtn" title="Novo perfil">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
          </button>
          <button class="btn" id="myProfileBtn" title="Meu perfil">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>
  <main class="wrap">
    <div class="grid">
      <section class="card pad" id="view">
        <!-- Views render here -->
      </section>
    </div>
  </main>
  <nav class="tabs">
    <button class="tab active" data-tab="feed" title="Feed">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 3h18v2H3V3zm0 4h18v10H3V7zm2 2v6h14V9H5zm-2 8h18v2H3v-2z"/></svg>
    </button>
    <button class="tab" data-tab="ranking" title="Ranking">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
    </button>
    <button class="tab" data-tab="postar" title="Postar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
    </button>
    <button class="tab" data-tab="perfis" title="Perfis">
      <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 24 24"
  width="48" height="48"
  fill="black"
  role="img"
  aria-label="√çcone de duas pessoas"
>
  <circle cx="9" cy="8" r="3.25"/>
  <circle cx="16.5" cy="9.5" r="2.75"/>
  <path d="M3.5 18.2c.6-2.9 3.3-4.7 6.1-4.7s5.5 1.8 6.1 4.7"/>
  <path d="M12.5 17.8c.4-2.2 2.5-3.6 4.6-3.6s4 1.4 4.6 3.6"/>
</svg>
    </button>
    <button class="tab" data-tab="sobre" title="Sobre">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    </button>
  </nav>
  <div id="modalRoot" style="display:none"></div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, onSnapshot,
      addDoc, query, orderBy, where, limit, arrayUnion, arrayRemove,
      deleteDoc, getDocs, Timestamp, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const $ = (s, root = document) => root.querySelector(s);
    const $$ = (s, root = document) => Array.from(root.querySelectorAll(s));
    const store = {
      get(k, def) { try { return JSON.parse(localStorage.getItem(k)) ?? def; } catch { return def; } },
      set(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
    };

    const COLORS = ["#e6edf3", "#dbe2ea", "#eef2f6", "#f4f7fb", "#e9eef6"];
    const EMOJIS = ["ü¶ä", "ü¶â", "üéÉ", "üêº", "üêß", "üëΩ", "üêô", "üë§", "üê±", "ü•∏", "üê∏", "üé±", "ü§ñ", "üëë", "‚≠êÔ∏è", "üéß", "üé≤", "üéØ", "üëæ"];
    const ADJ = ["Espectro", "Eclipse", "Criptico", "Bravo", "Prisma", "Nomade", "Atomo", "Lunar", "Solar", "Vortex", "Sigma", "Sombrio", "Nebuloso", "Enigma"];
    const NOUN = ["Eter", "Orion", "Quasar", "Zenith", "Umbra", "Caos", "Tesla", "Onyx", "Cronos", "Orbita", "Arcano", "Titan", "Oblivion"];
    const rnd = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4);

    function newRandomUser() {
      const name = `${rnd(ADJ)} ${rnd(NOUN)}-${Math.floor(Math.random() * 90 + 10)}`;
      const bg = rnd(COLORS);
      const emoji = rnd(EMOJIS);
      return { id: uid(), name, emoji, bg, createdAt: Date.now(), lastActive: Date.now(), lastReseed: 0 };
    }

    const DB = {
      user: null,
      users: [],
      messages: [],
      likes: {},
      connected: false,
      firestoreListenerUnsub: null,
      usersUnsub: null
    };

    const firebaseConfig = {
      apiKey: "AIzaSyDd-i47C51sseWaMtZbBBdPbObjP1_kYzU",
      authDomain: "minimaltag-28769.firebaseapp.com",
      projectId: "minimaltag-28769",
      storageBucket: "minimaltag-28769.firebasestorage.app",
      messagingSenderId: "645337589970",
      appId: "1:645337589970:web:24be0fabbc3f2b30eaa50b"
    };

    const app = initializeApp(firebaseConfig);
    const dbFire = getFirestore(app);
    const auth = getAuth();

    function hydrate() {
      DB.user = store.get('anon:user') || newRandomUser();
      DB.user.lastActive = Date.now();
      DB.users = store.get('anon:users', []);
      if (!DB.users.find(u => u.id === DB.user.id)) DB.users.push(DB.user);
      DB.messages = store.get('anon:messages', seedMessages());
      DB.likes = store.get('anon:likes', {});
      persist();
    }

    function persist() {
      store.set('anon:user', DB.user);
      store.set('anon:users', DB.users);
      store.set('anon:messages', DB.messages);
      store.set('anon:likes', DB.likes);
      renderHeader();
    }

    function seedMessages() {
      if (DB.messages.length > 0) return DB.messages;
      const samples = [
        { userId: DB.user.id, text: "Bem-vindos ao mural an√¥nimo!", createdAt: Date.now() - 3600_000 },
        { userId: DB.user.id, text: "Qual seu app favorito hoje?", createdAt: Date.now() - 1800_000 },
        { userId: DB.user.id, text: "Deixe aqui sua mensagem üëá", createdAt: Date.now() - 600_000 }
      ];
      return samples.map(m => ({ id: uid(), ...m }));
    }

    function countPostsToday() {
      const today = new Date().toDateString();
      return DB.messages.filter(m => m.userId === DB.user.id && new Date(m.createdAt).toDateString() === today).length;
    }

    function getUserBadges(userId) {
      let badges = [];
      const userPosts = DB.messages.filter(m => m.userId === userId);
      const totalLikes = userPosts.reduce((sum, m) => sum + countLikes(m.id), 0);
      const hasPosted = userPosts.length >= 100;
      const hasReceivedLikes = totalLikes >= 100;
      const user = DB.users.find(u => u.id === userId);
      const isVeteran = user && (Date.now() - user.createdAt) >= 100 * 24 * 3600 * 1000;

      if (hasReceivedLikes) {
        badges.push(`<span class="badge badge-legal" title="Legal"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.241 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></span>`);
      }
      if (hasPosted) {
        badges.push(`<span class="badge badge-caneta" title="Caneta"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></span>`);
      }
      if (isVeteran) {
        badges.push(`<span class="badge badge-vip" title="VIP"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3 7h7l-5.5 4.5L18 21l-6-3.5L6 21l1.5-7.5L2 9h7z"/></svg></span>`);
      }
      return badges.join('');
    }

    function getBadgeProgress(userId) {
      const userPosts = DB.messages.filter(m => m.userId === userId);
      const totalLikes = userPosts.reduce((sum, m) => sum + countLikes(m.id), 0);
      const user = DB.users.find(u => u.id === userId);
      const daysActive = user ? Math.floor((Date.now() - user.createdAt) / (24 * 3600 * 1000)) : 0;
      return {
        legal: { count: totalLikes, required: 100, has: totalLikes >= 100 },
        caneta: { count: userPosts.length, required: 100, has: userPosts.length >= 100 },
        vip: { count: daysActive, required: 100, has: daysActive >= 100 }
      };
    }

    const Views = {
      feed() {
        const container = document.createElement('div');
        const postsToday = countPostsToday();
        container.innerHTML = `<div class="row" style="justify-content:space-between;gap:8px;margin-bottom:8px">
            <h3 style="margin:0">Feed p√∫blico</h3>
            <div class="chip">Posts hoje: ${postsToday}/7</div>
          </div>`;
        const list = document.createElement('div');
        list.className = 'list';
        const fiveDaysAgo = Date.now() - 5 * 24 * 3600 * 1000;
        DB.messages.filter(m => m.createdAt > fiveDaysAgo).slice().sort((a, b) => b.createdAt - a.createdAt).forEach(msg => {
          list.appendChild(renderMessage(msg));
        });
        if (list.children.length === 0) {
          list.innerHTML = `<div class="empty">Sem mensagens ainda. V√° em <b>Postar</b> e mande a primeira!</div>`;
        }
        container.appendChild(list);
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        container.appendChild(spacer);
        return container;
      },
      ranking() {
        const container = document.createElement('div');
        const postsToday = countPostsToday();
        container.innerHTML = `<div class="row" style="justify-content:space-between;gap:8px;margin-bottom:8px">
            <h3 style="margin:0">Ranking ‚Ä¢ Top 10 mais curtidas</h3>
            <div class="chip">Posts hoje: ${postsToday}/7</div>
          </div>`;
        const list = document.createElement('div');
        list.className = 'list';
        DB.messages.slice().sort((a, b) => {
          const la = countLikes(a.id), lb = countLikes(b.id);
          if (lb !== la) return lb - la;
          return b.createdAt - a.createdAt;
        }).slice(0, 10).forEach(msg => list.appendChild(renderMessage(msg)));
        if (DB.messages.length === 0) {
          list.innerHTML = `<div class="empty">Nada por aqui ainda‚Ä¶ Poste algo e ganhe curtidas!</div>`;
        }
        container.appendChild(list);

        // Top 5 users by badge type
        container.innerHTML += `<div class="sep"></div><h3 style="margin:16px 0 8px">Top 5 por selo</h3>`;
        const badgeSection = document.createElement('div');
        badgeSection.className = 'list';

        const badgeTypes = [
          { name: 'Legal', key: 'legal', criteria: u => DB.messages.filter(m => m.userId === u.id).reduce((sum, m) => sum + countLikes(m.id), 0) },
          { name: 'Caneta', key: 'caneta', criteria: u => DB.messages.filter(m => m.userId === u.id).length },
          { name: 'VIP', key: 'vip', criteria: u => Math.floor((Date.now() - u.createdAt) / (24 * 3600 * 1000)) }
        ];

        badgeTypes.forEach(badge => {
          const topUsers = DB.users.slice()
            .filter(u => badge.criteria(u) >= 100)
            .sort((a, b) => badge.criteria(b) - badge.criteria(a))
            .slice(0, 5);
          
          const badgeDiv = document.createElement('div');
          badgeDiv.innerHTML = `<h4 style="margin:8px 0">${badge.name}</h4>`;
          const userList = document.createElement('div');
          userList.className = 'profiles';
          
          if (topUsers.length === 0) {
            userList.innerHTML = `<div class="empty">Nenhum usu√°rio com o selo ${badge.name}.</div>`;
          } else {
            topUsers.forEach(u => {
              const profileCard = renderProfileCard(u);
              const count = document.createElement('div');
              count.className = 'muted';
              count.style.fontSize = '12px';
              count.textContent = `${badge.criteria(u)} ${badge.key === 'vip' ? 'dias' : badge.key === 'legal' ? 'curtidas' : 'posts'}`;
              profileCard.appendChild(count);
              userList.appendChild(profileCard);
            });
          }
          
          badgeDiv.appendChild(userList);
          badgeSection.appendChild(badgeDiv);
        });

        container.appendChild(badgeSection);
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        container.appendChild(spacer);
        return container;
      },
      postar() {
        const container = document.createElement('div');
        container.innerHTML = `<h3 style="margin-top:0">Postar mensagem</h3>`;
        const textareaContainer = document.createElement('div');
        textareaContainer.className = 'textarea-container';
        const area = document.createElement('textarea');
        area.placeholder = "Escreva algo gentil, curioso ou divertido‚Ä¶";
        area.maxLength = 280;
        const charCount = document.createElement('div');
        charCount.className = 'muted';
        charCount.style.textAlign = 'right';
        charCount.textContent = '0/280';
        const btn = document.createElement('button');
        btn.className = 'btn primary';
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>`;
        btn.title = 'Publicar';
        const postsToday = countPostsToday();
        btn.disabled = postsToday >= 7;
        area.oninput = () => {
          charCount.textContent = `${area.value.length}/280`;
          btn.disabled = postsToday >= 7 || area.value.trim().length === 0;
        };
        btn.onclick = async () => {
          const text = area.value.trim();
          if (text.length === 0 || postsToday >= 7) { area.focus(); return; }
          DB.user.lastActive = Date.now();
          const msg = { id: uid(), userId: DB.user.id, text, createdAt: Date.now() };
          DB.messages.unshift(msg);
          persist();
          area.value = '';
          if (DB.connected) {
            try {
              await addDoc(collection(dbFire, 'messages'), {
                userId: DB.user.id,
                text,
                createdAt: Timestamp.fromMillis(msg.createdAt),
                likes: []
              });
              await updateUserLastActive();
            } catch (err) {
              console.error('Erro ao enviar para Firestore:', err);
            }
          }
          switchTab('feed');
        };
        if (postsToday >= 7) {
          const limitNote = document.createElement('div');
          limitNote.className = 'muted-note';
          limitNote.style.color = 'var(--danger)';
          limitNote.textContent = 'Voc√™ atingiu o limite de 7 posts por dia.';
          container.appendChild(limitNote);
        }
        textareaContainer.appendChild(area);
        textareaContainer.appendChild(btn);
        container.appendChild(textareaContainer);
        container.appendChild(charCount);
        container.appendChild(document.createElement('div')).className = 'sep';
        const tips = document.createElement('div');
        tips.className = 'muted';
        tips.innerHTML = 'Dica: clique no seu nome em qualquer mensagem para ver seu mural pessoal.';
        container.appendChild(tips);
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        container.appendChild(spacer);
        return container;
      },
      perfis() {
        const container = document.createElement('div');
        container.innerHTML = `<h3 style="margin-top:0">Perfis ativos (√∫ltimas 24 horas)</h3>`;
        const grid = document.createElement('div');
        grid.className = 'profiles';
        const threeDays = 1 * 24 * 60 * 60 * 1000;
        const activeUsers = DB.users.filter(u => (Date.now() - (u.lastActive || u.createdAt)) <= threeDays);
        activeUsers.sort((a, b) => (b.lastActive || b.createdAt) - (a.lastActive || a.createdAt)).forEach(u => {
          grid.appendChild(renderProfileCard(u));
        });
        if (activeUsers.length === 0) {
          grid.innerHTML = `<div class="empty">Nenhum perfil ativo nas ultimas 24 horas.</div>`;
        }
        container.appendChild(grid);
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        container.appendChild(spacer);
        return container;
      },
      sobre() {
        const container = document.createElement('div');
        container.innerHTML = `<div class="row" style="justify-content:space-between;gap:8px;margin-bottom:8px">
            <h3 style="margin:0">Sobre o Fokachat</h3>
          </div>`;
        const list = document.createElement('div');
        list.className = 'list';
        list.innerHTML = `
          <div class="ranking-text">
            O <b>Fokachat</b> √© um mural an√¥nimo para compartilhar ideias, pensamentos e mensagens de forma divertida, gentil e criativa. Aqui, voc√™ pode se expressar livremente usando um perfil an√¥nimo, interagir com outros usu√°rios e construir uma comunidade vibrante. Confira como aproveitar ao m√°ximo:
          </div>
          <div class="sep"></div>
          <div class="ranking-text"><b>Feed</b>: Explore mensagens p√∫blicas postadas nos √∫ltimos 5 dias, organizadas por ordem cronol√≥gica (do mais recente ao mais antigo). √â o lugar perfeito para se inspirar e acompanhar o que a comunidade est√° compartilhando!</div>
          <div class="ranking-text"><b>Postar</b>: Escreva mensagens curtas (at√© 280 caracteres) e publique no feed p√∫blico. Voc√™ pode postar at√© <b>7 mensagens por dia</b>. Seja criativo, gentil ou curioso, mas sempre respeite os outros!</div>
          <div class="ranking-text"><b>Ranking</b>: Veja as <b>10 mensagens mais curtidas</b> de todos os tempos. Curta mensagens que voc√™ gosta clicando no √≠cone de cora√ß√£o (‚ô°) e ajude suas favoritas a subirem no ranking!</div>
          <div class="ranking-text"><b>Perfis</b>: Descubra perfis ativos (que interagiram nas √∫ltimas 24 horas). Clique no nome ou no bot√£o "Ver mural" para explorar as mensagens de um usu√°rio espec√≠fico.</div>
          <div class="ranking-text"><b>Meu Perfil</b>: Veja suas mensagens, mensagens curtidas e progresso dos selos clicando no bot√£o de perfil no cabe√ßalho.</div>
          <div class="ranking-text"><b>Sincronizar Perfil</b>: Quer usar o mesmo perfil an√¥nimo em outro dispositivo? No cabe√ßalho, clique no √≠cone de exporta√ß√£o para gerar um c√≥digo de transfer√™ncia. Depois, em outro navegador ou dispositivo, use o √≠cone de importa√ß√£o e cole o c√≥digo para carregar seu perfil. <b>Cuidado</b>: guarde o c√≥digo em seguran√ßa, pois ele d√° acesso ao seu ID an√¥nimo!</div>
          <div class="ranking-text"><b>Novo Perfil</b>: Cansado do seu perfil atual? Clique no √≠cone de novo perfil no cabe√ßalho para criar um novo ID an√¥nimo. Observa√ß√£o: voc√™ s√≥ pode gerar um novo perfil uma vez por dia.</div>
          <div class="ranking-text"><b>Selos</b>: Ganhe selos ao interagir no Fokachat! <span class="badge badge-legal"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></span> por receber 100 ou mais curtidas no total, <span class="badge badge-caneta"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></span> por postar 100 ou mais mensagens e <span class="badge badge-vip"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3 7h7l-5.5 4.5L18 21l-6-3.5L6 21l1.5-7.5L2 9h7z"/></svg></span> por ter um perfil com mais de 100 dias. Mostre sua participa√ß√£o!</div>
          <div class="sep"></div>
          <div class="ranking-text">
            <b>Dica inicial</b>: Comece explorando o <b>Feed</b>, publique sua primeira mensagem em <b>Postar</b> e confira os perfis ativos em <b>Perfis</b>. Divirta-se e fa√ßa parte da comunidade Fokachat!
          </div>
        `;
        container.appendChild(list);
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        container.appendChild(spacer);
        return container;
      },
      meuPerfil() {
        const container = document.createElement('div');
        const user = DB.user;
        container.innerHTML = `<div class="row" style="justify-content:space-between;gap:8px;margin-bottom:8px">
            <h3 style="margin:0">Meu Perfil ‚Ä¢ @${user.name}</h3>
            <div class="chip">Minhas intera√ß√µes</div>
          </div>`;

        // Toggle Buttons
        const toggleContainer = document.createElement('div');
        toggleContainer.className = 'row';
        toggleContainer.style.marginBottom = '12px';
        const buttons = [
          { id: 'myPostsBtn', title: 'Minhas mensagens', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>' },
          { id: 'likedPostsBtn', title: 'Mensagens que curti', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>' },
          { id: 'badgesBtn', title: 'Progresso dos selos', icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3 7h7l-5.5 4.5L18 21l-6-3.5L6 21l1.5-7.5L2 9h7z"/></svg>' }
        ];
        buttons.forEach(btn => {
          const button = document.createElement('button');
          button.className = `btn btn-toggle ${btn.id === 'myPostsBtn' ? 'primary' : ''}`;
          button.innerHTML = btn.icon;
          button.title = btn.title;
          button.dataset.section = btn.id.replace('Btn', '');
          toggleContainer.appendChild(button);
        });
        container.appendChild(toggleContainer);

        // My Posts
        const myPosts = document.createElement('div');
        myPosts.className = 'list section-toggle active';
        myPosts.id = 'myPosts';
        const userPosts = DB.messages.filter(m => m.userId === user.id).sort((a, b) => b.createdAt - a.createdAt);
        userPosts.forEach(m => myPosts.appendChild(renderMessage(m)));
        if (userPosts.length === 0) {
          myPosts.innerHTML = `<div class="empty">Voc√™ ainda n√£o postou nada. V√° em <b>Postar</b> para come√ßar!</div>`;
        }
        container.appendChild(myPosts);

        // Liked Messages
        const likedPosts = document.createElement('div');
        likedPosts.className = 'list section-toggle';
        likedPosts.id = 'likedPosts';
        const likedMessages = DB.messages.filter(m => hasLiked(m.id, user.id)).sort((a, b) => b.createdAt - a.createdAt);
        likedMessages.forEach(m => likedPosts.appendChild(renderMessage(m)));
        if (likedMessages.length === 0) {
          likedPosts.innerHTML = `<div class="empty">Voc√™ ainda n√£o curtiu nenhuma mensagem.</div>`;
        }
        container.appendChild(likedPosts);

        // Badge Progress Table
        const badges = document.createElement('div');
        badges.className = 'section-toggle';
        badges.id = 'badges';
        const table = document.createElement('table');
        table.className = 'table';
        table.innerHTML = `
          <thead>
            <tr>
              <th>Selo</th>
              <th>Progresso</th>
              <th>Meta</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        `;
        const progress = getBadgeProgress(user.id);
        const tbody = table.querySelector('tbody');
        const badgeData = [
          { name: 'Legal', data: progress.legal, unit: 'curtidas' },
          { name: 'Caneta', data: progress.caneta, unit: 'posts' },
          { name: 'VIP', data: progress.vip, unit: 'dias' }
        ];
        badgeData.forEach(badge => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${badge.name}</td>
            <td>${badge.data.count} ${badge.unit}</td>
            <td>${badge.data.required} ${badge.unit}</td>
            <td>${badge.data.has ? '‚úÖ Conquistado' : '‚è≥ Em progresso'}</td>
          `;
          tbody.appendChild(tr);
        });
        badges.appendChild(table);
        container.appendChild(badges);

        // Toggle Logic
        toggleContainer.querySelectorAll('.btn-toggle').forEach(btn => {
          btn.addEventListener('click', () => {
            toggleContainer.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('primary'));
            btn.classList.add('primary');
            container.querySelectorAll('.section-toggle').forEach(section => {
              section.classList.toggle('active', section.id === btn.dataset.section);
            });
          });
        });

        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        container.appendChild(spacer);
        return container;
      },
      usuario(userId) {
        const user = DB.users.find(u => u.id === userId);
        const container = document.createElement('div');
        if (!user) {
          container.innerHTML = `<div class="empty">Usu√°rio n√£o encontrado.</div>`;
          const spacer = document.createElement('div');
          spacer.className = 'spacer';
          container.appendChild(spacer);
          return container;
        }
        container.innerHTML = `<div class="row" style="justify-content:space-between;gap:8px;margin-bottom:8px">
            <h3 style="margin:0">@${user.name}</h3>
            <div class="chip">Mensagens deste perfil</div>
          </div>`;
        const list = document.createElement('div');
        list.className = 'list';
        DB.messages.filter(m => m.userId === userId).sort((a, b) => b.createdAt - a.createdAt).forEach(m => list.appendChild(renderMessage(m)));
        if (list.children.length === 0) {
          list.innerHTML = `<div class="empty">Este perfil ainda n√£o postou nada.</div>`;
        }
        container.appendChild(list);
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        container.appendChild(spacer);
        return container;
      }
    };

    function renderHeader() {
      const me = DB.user;
      const meLine = `Conectado como <b>${me.name}${getUserBadges(me.id)}</b> ${DB.connected ? '‚úÖ' : ''}`;
      $('#meLine').innerHTML = meLine;
      const headerAv = $('#headerAvatar');
      headerAv.innerHTML = '';
      const av = makeAvatar(me);
      av.classList.add('small');
      headerAv.appendChild(av);
    }

    function makeAvatar(user, size = '44px') {
      const d = document.createElement('div');
      d.className = 'avatar';
      d.style.width = size;
      d.style.height = size;
      d.style.background = user.bg;
      d.textContent = user.emoji;
      d.title = user.name;
      return d;
    }

    function renderProfileCard(u) {
      const row = document.createElement('div');
      row.className = 'profile';
      row.appendChild(makeAvatar(u));
      const col = document.createElement('div');
      col.style.flex = '1';
      const link = document.createElement('a');
      link.className = 'link';
      link.innerHTML = u.name + getUserBadges(u.id);
      link.href = '#';
      link.onclick = (e) => { e.preventDefault(); showUser(u.id); };
      const small = document.createElement('div');
      small.className = 'muted';
      small.style.fontSize = '12px';
      small.textContent = `Ativo ${timeAgo(u.lastActive || u.createdAt)}`;
      col.appendChild(link);
      col.appendChild(small);
      row.appendChild(col);
      const btn = document.createElement('button');
      btn.className = 'btn ghost';
      btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="√çcone de uma pessoa"><circle cx="12" cy="7" r="4"/><path d="M5.5 20c.7-3.5 3.6-6 6.5-6s5.8 2.5 6.5 6"/></svg>`;
      btn.title = 'Ver mural';
      btn.onclick = () => showUser(u.id);
      row.appendChild(btn);
      return row;
    }

    function renderMessage(msg) {
      const user = DB.users.find(u => u.id === msg.userId) || { name: '(desconhecido)', emoji: '‚ùî', bg: '#ddd' };
      const el = document.createElement('div');
      el.className = 'msg';
      const av = makeAvatar(user);
      const content = document.createElement('div');
      content.className = 'content';
      const nameLink = document.createElement('a');
      nameLink.className = 'link';
      nameLink.href = '#';
      nameLink.innerHTML = user.name + getUserBadges(user.id);
      nameLink.onclick = (e) => { e.preventDefault(); showUser(user.id); };
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<span class="muted">${timeAgo(msg.createdAt)}</span>`;
      const likeBtn = document.createElement('button');
      likeBtn.className = 'btn like';
      const liked = hasLiked(msg.id, DB.user.id);
      likeBtn.innerHTML = liked ? `‚ù§ ${countLikes(msg.id)}` : `‚ô° ${countLikes(msg.id)}`;
      likeBtn.onclick = () => { toggleLike(msg.id, DB.user.id); updateView(); };
      const text = document.createElement('div');
      text.className = 'ranking-text';
      text.style.margin = '6px 0 8px';
      text.textContent = msg.text;
      const headerRow = document.createElement('div');
      headerRow.className = 'row';
      headerRow.style.justifyContent = 'space-between';
      const left = document.createElement('div');
      left.appendChild(nameLink);
      headerRow.appendChild(left);
      headerRow.appendChild(meta);
      content.appendChild(headerRow);
      content.appendChild(text);
      el.appendChild(av);
      el.appendChild(content);
      el.appendChild(likeBtn);
      return el;
    }

    function hasLiked(messageId, userId) {
      const set = new Set(DB.likes[messageId] || []);
      return set.has(userId);
    }

    function countLikes(messageId) {
      const set = new Set(DB.likes[messageId] || []);
      return set.size;
    }

    async function toggleLike(messageId, userId) {
      DB.user.lastActive = Date.now();
      let arr = new Set(DB.likes[messageId] || []);
      const liked = arr.has(userId);
      if (liked) arr.delete(userId);
      else arr.add(userId);
      DB.likes[messageId] = Array.from(arr);
      persist();
      if (DB.connected) {
        try {
          const localMsg = DB.messages.find(m => m.id === messageId);
          if (localMsg && localMsg._firestoreId) {
            const docRef = doc(dbFire, 'messages', localMsg._firestoreId);
            if (liked) {
              await updateDoc(docRef, { likes: arrayRemove(DB.user.id) });
            } else {
              await updateDoc(docRef, { likes: arrayUnion(DB.user.id) });
            }
          } else {
            if (localMsg) {
              const q = query(collection(dbFire, 'messages'), where('createdAt', '==', Timestamp.fromMillis(localMsg.createdAt)), where('userId', '==', localMsg.userId), limit(1));
              const snap = await getDocs(q);
              if (!snap.empty) {
                const docRef = snap.docs[0].ref;
                if (liked) await updateDoc(docRef, { likes: arrayRemove(DB.user.id) });
                else await updateDoc(docRef, { likes: arrayUnion(DB.user.id) });
              }
            }
          }
          await updateUserLastActive();
        } catch (err) {
          console.error('Erro ao atualizar likes na nuvem:', err);
        }
      }
    }

    function switchTab(tab) {
      $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      if (tab === 'feed') mount(Views.feed());
      if (tab === 'ranking') mount(Views.ranking());
      if (tab === 'postar') mount(Views.postar());
      if (tab === 'perfis') mount(Views.perfis());
      if (tab === 'sobre') mount(Views.sobre());
      location.hash = '#' + tab;
    }

    function showUser(userId) {
      $$('.tab').forEach(t => t.classList.remove('active'));
      mount(Views.usuario(userId));
      location.hash = '#user:' + userId;
    }

    function showMyProfile() {
      $$('.tab').forEach(t => t.classList.remove('active'));
      mount(Views.meuPerfil());
      location.hash = '#meuPerfil';
    }

    function mount(node) {
      const root = $('#view');
      root.innerHTML = '';
      root.appendChild(node);
    }

    function updateView() {
      const h = location.hash.slice(1);
      if (h.startsWith('user:')) { mount(Views.usuario(h.split(':')[1])); return; }
      if (h === 'meuPerfil') { mount(Views.meuPerfil()); return; }
      if (h === 'ranking') switchTab('ranking');
      else if (h === 'postar') switchTab('postar');
      else if (h === 'perfis') switchTab('perfis');
      else if (h === 'sobre') switchTab('sobre');
      else switchTab('feed');
    }

    function timeAgo(ts) {
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60) return `${s}s`;
      const m = Math.floor(s / 60);
      if (m < 60) return `${m}m`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h}h`;
      const d = Math.floor(h / 24);
      return `${d}d`;
    }

    async function updateUserLastActive() {
      if (DB.connected) {
        try {
          const userDocRef = doc(dbFire, 'users', DB.user.id);
          await setDoc(userDocRef, { lastActive: Timestamp.fromMillis(DB.user.lastActive) }, { merge: true });
        } catch (e) {
          console.warn('N√£o foi poss√≠vel atualizar lastActive na nuvem', e);
        }
      }
    }

    async function startFirestoreSync(firebaseUid) {
      DB.connected = true;
      renderHeader();
      try {
        const usersCol = collection(dbFire, 'users');
        DB.usersUnsub = onSnapshot(usersCol, snapshot => {
          snapshot.docChanges().forEach(change => {
            const data = change.doc.data();
            const u = {
              id: data.id,
              name: data.name,
              emoji: data.emoji,
              bg: data.bg,
              createdAt: data.createdAt?.toMillis?.() ?? Date.now(),
              lastActive: data.lastActive?.toMillis?.() ?? data.createdAt?.toMillis?.() ?? Date.now()
            };
            const idx = DB.users.findIndex(x => x.id === u.id);
            if (change.type === 'added' || change.type === 'modified') {
              if (idx === -1) DB.users.push(u);
              else DB.users[idx] = u;
            } else if (change.type === 'removed') {
              if (idx !== -1) DB.users.splice(idx, 1);
            }
          });
          persist();
          updateView();
        });
      } catch (err) { console.warn('users listener failed', err); }
      try {
        const q = query(collection(dbFire, 'messages'), orderBy('createdAt', 'desc'));
        if (DB.firestoreListenerUnsub) DB.firestoreListenerUnsub();
        DB.firestoreListenerUnsub = onSnapshot(q, snapshot => {
          const messages = [];
          const likesMap = {};
          snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const ms = {
              id: docSnap.id + '-' + (d.createdAt?.toMillis?.() ?? Date.now()),
              _firestoreId: docSnap.id,
              userId: d.userId,
              text: d.text,
              createdAt: d.createdAt?.toMillis?.() ?? Date.now()
            };
            messages.push(ms);
            likesMap[ms.id] = Array.isArray(d.likes) ? d.likes.slice() : [];
          });
          DB.messages = messages;
          DB.likes = likesMap;
          persist();
          updateView();
        });
      } catch (err) { console.warn('messages listener failed', err); }
      try {
        const userDocRef = doc(dbFire, 'users', DB.user.id);
        await setDoc(userDocRef, {
          id: DB.user.id,
          name: DB.user.name,
          emoji: DB.user.emoji,
          bg: DB.user.bg,
          createdAt: Timestamp.fromMillis(DB.user.createdAt),
          lastActive: Timestamp.fromMillis(DB.user.lastActive)
        }, { merge: true });
      } catch (err) {
        console.warn('N√£o foi poss√≠vel garantir usu√°rio na nuvem', err);
      }
    }

    function stopFirestoreSync() {
      DB.connected = false;
      if (DB.firestoreListenerUnsub) { DB.firestoreListenerUnsub(); DB.firestoreListenerUnsub = null; }
      if (DB.usersUnsub) { DB.usersUnsub(); DB.usersUnsub = null; }
      renderHeader();
    }

    hydrate();
    updateView();
    try {
      signInAnonymously(auth).then(() => {
        console.log('Tentando autenticar anonimamente...');
      }).catch((error) => {
        console.warn('Erro ao signInAnonymously', error);
      });
      onAuthStateChanged(auth, user => {
        if (user) {
          console.log('Autenticado anon:', user.uid);
          DB.user.lastActive = Date.now();
          startFirestoreSync(user.uid).then(() => updateUserLastActive()).catch(err => console.error(err));
        } else {
          console.log('N√£o autenticado');
          stopFirestoreSync();
        }
      });
    } catch (err) {
      console.warn('Firebase init falhou', err);
    }

    $$('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
    $('#myProfileBtn').addEventListener('click', showMyProfile);
    window.addEventListener('hashchange', updateView);

    function updateViewAndPersist() { persist(); updateView(); }
    window.updateView = updateViewAndPersist;

    async function deriveIdFromCode(code) {
      const normalized = String(code).trim();
      const enc = new TextEncoder().encode('transfer-v1:' + normalized);
      const hashBuf = await crypto.subtle.digest('SHA-256', enc);
      const h = Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
      return 'anon-' + h.slice(0, 12);
    }

    function generateTransferCode(len = 16) {
      const arr = new Uint8Array(Math.ceil(len * 0.6));
      crypto.getRandomValues(arr);
      let s = '';
      for (let i = 0; i < arr.length; i++) {
        s += arr[i].toString(36).padStart(2, '0');
      }
      s = s.replace(/[^a-z0-9]/gi, '').slice(0, len);
      return s.toUpperCase();
    }

    function showModal(html) {
      const root = $('#modalRoot');
      root.innerHTML = '';
      root.style.display = 'grid';
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `<div class="box">${html}</div>`;
      modal.onclick = (e) => { if (e.target === modal) closeModal(); };
      root.appendChild(modal);
    }

    function closeModal() {
      const root = $('#modalRoot');
      root.style.display = 'none';
      root.innerHTML = '';
    }

    async function transferOwnership(oldId, newId) {
      if (oldId === newId) return;
      DB.messages.forEach(m => {
        if (m.userId === oldId) m.userId = newId;
      });
      Object.keys(DB.likes).forEach(mid => {
        let arr = DB.likes[mid];
        if (arr.includes(oldId)) {
          DB.likes[mid] = arr.filter(uid => uid !== oldId);
          if (!DB.likes[mid].includes(newId)) DB.likes[mid].push(newId);
        }
      });
      const idx = DB.users.findIndex(u => u.id === oldId);
      if (idx !== -1) DB.users.splice(idx, 1);
      if (DB.connected) {
        try {
          const qm = query(collection(dbFire, 'messages'), where('userId', '==', oldId));
          const snapm = await getDocs(qm);
          for (let ds of snapm.docs) {
            await updateDoc(ds.ref, { userId: newId });
          }
          const ql = query(collection(dbFire, 'messages'), where('likes', 'array-contains', oldId));
          const snapl = await getDocs(ql);
          for (let ds of snapl.docs) {
            await updateDoc(ds.ref, { likes: arrayRemove(oldId) });
            await updateDoc(ds.ref, { likes: arrayUnion(newId) });
          }
          const oldRef = doc(dbFire, 'users', oldId);
          await deleteDoc(oldRef);
        } catch (err) {
          console.error('Error transferring ownership:', err);
        }
      }
      persist();
    }

    async function handleGenerateCode() {
      const code = generateTransferCode(16);
      const derivedId = await deriveIdFromCode(code);
      const prev = DB.user;
      DB.user = { id: derivedId, name: prev.name, emoji: prev.emoji, bg: prev.bg, createdAt: prev.createdAt ?? Date.now(), lastActive: Date.now(), lastReseed: prev.lastReseed || 0 };
      if (!DB.users.find(u => u.id === DB.user.id)) DB.users.push(DB.user);
      await transferOwnership(prev.id, derivedId);
      persist();
      try {
        if (DB.connected) {
          const userDocRef = doc(dbFire, 'users', DB.user.id);
          await setDoc(userDocRef, {
            id: DB.user.id,
            name: DB.user.name,
            emoji: DB.user.emoji,
            bg: DB.user.bg,
            createdAt: Timestamp.fromMillis(DB.user.createdAt),
            lastActive: Timestamp.fromMillis(DB.user.lastActive)
          }, { merge: true });
        }
      } catch (e) { console.warn('N√£o foi poss√≠vel salvar usu√°rio gerado na nuvem', e); }
      showModal(`
        <h3>C√≥digo de transfer√™ncia gerado</h3>
        <div style="margin-top:8px">Use este c√≥digo em outro navegador para carregar o <b>mesmo</b> perfil an√¥nimo:</div>
        <div style="margin-top:12px"><div class="code" id="transferCode">${code}</div></div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn primary" id="copyCode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
          <button class="btn" id="closeModalBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="muted-note">Observa√ß√£o: quem tiver este c√≥digo poder√° usar este mesmo ID an√¥nimo. Guarde com responsabilidade.</div>        
      `);
      $('#copyCode').onclick = () => {
        navigator.clipboard.writeText(code).then(() => alert('C√≥digo copiado!'));
      };
      $('#closeModalBtn').onclick = closeModal;
    }

    async function handleImportCode() {
      showModal(`
        <h3>Importar c√≥digo</h3>
        <div style="margin-top:6px">Cole o c√≥digo de transfer√™ncia recebido:</div>
        <div style="margin-top:10px"><input id="inputCode" type="text" placeholder="Ex: A1B2C3D4E5F6G7H8" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd"></div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn primary" id="doImport"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 22l5-5h-3v-7h-4v7H7l5 5zm0-10V2h4v2H8v-2h4v10z"/></svg></button>
          <button class="btn" id="cancelImport"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="muted-note">Ao importar, voc√™ passar√° a usar o mesmo ID associado ao c√≥digo.</div>
      `);
      $('#cancelImport').onclick = closeModal;
      $('#doImport').onclick = async () => {
        const code = $('#inputCode').value.trim();
        if (!code) { alert('Cole um c√≥digo v√°lido.'); return; }
        const derivedId = await deriveIdFromCode(code);
        const oldId = DB.user.id;
        let existing = DB.users.find(u => u.id === derivedId);
        if (existing) {
          DB.user = { ...existing, lastActive: Date.now(), lastReseed: existing.lastReseed || 0 };
        } else {
          const newUser = {
            id: derivedId,
            name: DB.user.name + ' (import)',
            emoji: DB.user.emoji,
            bg: DB.user.bg,
            createdAt: Date.now(),
            lastActive: Date.now(),
            lastReseed: 0
          };
          DB.users.push(newUser);
          DB.user = newUser;
        }
        await transferOwnership(oldId, derivedId);
        persist();
        try {
          if (DB.connected) {
            const userDocRef = doc(dbFire, 'users', DB.user.id);
            await setDoc(userDocRef, {
              id: DB.user.id,
              name: DB.user.name,
              emoji: DB.user.emoji,
              bg: DB.user.bg,
              createdAt: Timestamp.fromMillis(DB.user.createdAt),
              lastActive: Timestamp.fromMillis(DB.user.lastActive)
            }, { merge: true });
          }
        } catch (e) { console.warn('N√£o foi poss√≠vel garantir usu√°rio na nuvem', e); }
        closeModal();
        alert('Perfil importado. Agora voc√™ usa o mesmo ID neste navegador.');
      };
    }

    function handleReseed() {
      const now = Date.now();
      if (now - (DB.user.lastReseed || 0) < 24 * 3600 * 1000) {
        alert('S√≥ permitido gerar novo perfil aleat√≥rio 1 vez por dia.');
        return;
      }
      if (confirm('Gerar um novo perfil aleat√≥rio (isso mudar√° seu ID local)?')) {
        const nv = newRandomUser();
        DB.user = nv;
        DB.user.lastReseed = now;
        if (!DB.users.find(u => u.id === nv.id)) DB.users.push(nv);
        persist();
        (async () => {
          try {
            if (DB.connected) {
              const userDocRef = doc(dbFire, 'users', DB.user.id);
              await setDoc(userDocRef, {
                id: DB.user.id,
                name: DB.user.name,
                emoji: DB.user.emoji,
                bg: DB.user.bg,
                createdAt: Timestamp.fromMillis(DB.user.createdAt),
                lastActive: Timestamp.fromMillis(DB.user.lastActive)
              }, { merge: true });
            }
          } catch (e) {}
        })();
      }
    }

    $('#genCodeBtn').addEventListener('click', handleGenerateCode);
    $('#importCodeBtn').addEventListener('click', handleImportCode);
    $('#reseedBtn').addEventListener('click', handleReseed);
  </script>    
</body>
</html>
