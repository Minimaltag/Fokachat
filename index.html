<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f1220">
  <title>Fokachat</title>    
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    :root{
      --bg:#0e1116;
      --panel:#151a22;
      --muted:#9aa4b2;
      --text:#e7edf4;
      --brand:#7c5cff;
      --brand-2:#3dd6ed;
      --ok:#28d17c;
      --danger:#ff6b6b;
      --ring: 0 0 0 2px color-mix(in srgb, var(--brand) 40%, transparent);
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(124,92,255,.08), transparent 60%),
                  radial-gradient(900px 700px at -10% 110%, rgba(61,214,237,.08), transparent 50%),
                  var(--bg);
      color:var(--text);
      font: 500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Color Emoji", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      height:100%;
      padding:18px;
    }
    .card{
      background: color-mix(in srgb, var(--panel) 94%, #000 6%);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .sidebar{
      display:flex; flex-direction:column; gap:14px; padding:14px;
    }
    .profile{
      display:flex; align-items:center; gap:12px; padding:12px;
      border-radius:12px; background: rgba(255,255,255,.03);
      border:1px dashed rgba(255,255,255,.06);
    }
    .avatar{
      width:54px; height:54px; border-radius:14px;
      display:grid; place-items:center; font-size:32px;
      background: linear-gradient(135deg, rgba(124,92,255,.18), rgba(61,214,237,.18));
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer; user-select:none;
    }
    .profile-info{flex:1}
    .profile-info input{
      width:100%; background:transparent; border:none; color:var(--text);
      font-weight:700; font-size:18px; outline:none;
    }
    .profile-actions{display:flex; gap:8px}
    .btn{
      appearance:none; border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px; font-weight:700; color:#0d0f14;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: 0 8px 20px rgba(124,92,255,.25);
      transition: transform .06s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.secondary{
      background: rgba(255,255,255,.06); color:var(--text);
      box-shadow:none; border:1px solid rgba(255,255,255,.08);
    }
    .section-title{
      font-size:13px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted);
      margin:6px 6px 6px 6px;
    }
    .groups{
      display:flex; flex-direction:column; gap:8px; overflow:auto; padding:6px;
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.2) transparent;
    }
    .group{
      display:flex; align-items:center; gap:10px; padding:12px;
      border-radius:12px; cursor:pointer; border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition: background .15s ease, border-color .15s ease;
    }
    .group:hover{background: rgba(255,255,255,.04)}
    .group.active{
      background: linear-gradient(135deg, rgba(124,92,255,.20), rgba(61,214,237,.20));
      border-color: rgba(255,255,255,.12);
    }
    .group-emoji{font-size:20px}
    .group-title{font-weight:700}
    .group-actions{margin-left:auto; display:flex; gap:6px}
    .icon-btn{
      background:transparent; border:none; color:var(--muted); cursor:pointer; padding:6px; border-radius:8px;
    }
    .icon-btn:hover{background: rgba(255,255,255,.06); color:var(--text)}
    .search{
      display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px;
      background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); margin: 6px;
    }
    .search input{
      flex:1; background:transparent; border:none; color:var(--text); outline:none;
    }
    .main{
      display:grid; grid-template-rows: auto 1fr auto; padding:14px;
    }
    .chat-header{
      display:flex; align-items:center; justify-content:space-between; padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .chat-header h2{margin:0; font-size:20px}
    .pill{
      font-size:12px; color:var(--text); opacity:.8; padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    }
    .messages{
      overflow:auto; padding:14px; display:flex; flex-direction:column; gap:12px;
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.2) transparent;
    }
    .msg{
      display:grid; grid-template-columns: 44px 1fr; gap:10px;
      animation: fadeIn .2s ease both;
    }
    .msg .a{
      width:44px; height:44px; border-radius:12px; display:grid; place-items:center; font-size:24px;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    }
    .bubble{
      background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px 12px;
    }
    .meta{font-size:12px; color:var(--muted); margin-bottom:4px; display:flex; gap:8px; flex-wrap:wrap}
    .composer{
      display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,.06);
      position:sticky; bottom:0; background:transparent; backdrop-filter: blur(4px);
    }
    .composer textarea{
      flex:1; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px;
      padding:12px; color:var(--text); outline:none; resize:none; min-height:48px; max-height:160px;
      box-shadow: inset 0 2px 10px rgba(0,0,0,.15);
    }
    .composer .btn{min-width:110px}
    .tip{
      font-size:12px; color:var(--muted); text-align:center; padding:6px 0 0;
    }
    @keyframes fadeIn{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none}}
    .emoji-picker{
      position:fixed; inset:auto auto 90px 26px; z-index:50;
      width:320px; max-width:calc(100% - 40px);
      background: var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow: var(--shadow);
      padding:10px; display:none;
    }
    .emoji-grid{
      display:grid; grid-template-columns: repeat(8, 1fr); gap:6px;
      max-height:260px; overflow:auto; padding:4px;
    }
    .emoji-grid button{
      font-size:20px; line-height:1; background:transparent; border:none; cursor:pointer; padding:8px; border-radius:10px;
    }
    .emoji-grid button:hover{background: rgba(255,255,255,.08)}
    .emoji-search{width:100%; margin:6px 0 8px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.1);
      background: rgba(255,255,255,.04); color:var(--text); outline:none}
    .emoji-actions{display:flex; justify-content:space-between; align-items:center; padding:4px 2px 0}
    .emoji-actions .btn{padding:8px 10px; border-radius:10px}
    @media (max-width: 880px){
      .app{grid-template-columns: 1fr; height:auto}
      .sidebar{order:2}
      .main{order:1; height: 100dvh}
    }
    .focus-ring:focus{outline:none; box-shadow: var(--ring)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;}
  </style>
</head>
<body>
  <div class="app">
    <aside class="card sidebar" aria-label="Barra lateral">
      <div class="profile" aria-label="Perfil an√¥nimo">
        <button id="avatarBtn" class="avatar focus-ring" title="Escolher emoji do avatar" aria-label="Escolher emoji do avatar">üôÇ</button>
        <div class="profile-info">
          <input id="displayName" class="focus-ring" type="text" placeholder="Seu nome an√¥nimo" aria-label="Nome de exibi√ß√£o (an√¥nimo)" />
          <div style="display:flex; gap:8px; margin-top:6px">
            <button id="randomNameBtn" class="btn secondary" title="Gerar nome aleat√≥rio">‚Üª Aleat√≥rio</button>
            <button id="saveProfileBtn" class="btn secondary" title="Salvar perfil">Salvar</button>
          </div>
        </div>
      </div>
      <div class="search">
        <span aria-hidden="true">üîé</span>
        <input id="groupSearch" type="search" placeholder="Buscar grupos..." aria-label="Buscar grupos" />
        <button id="addGroupBtn" class="btn" title="Criar novo grupo">+ Grupo</button>
      </div>
      <div class="section-title">Seus Grupos</div>
      <div id="groupList" class="groups" role="listbox" aria-label="Lista de grupos"></div>
      <div class="section-title">Grupos Populares</div>
      <div id="popularGroups" class="groups" role="listbox" aria-label="Lista de grupos populares"></div>
      <div class="tip">Dica: crie grupos por tema e converse com liberdade. Sincronizado na nuvem.</div>
    </aside>
    <main class="card main" aria-label="√Årea do chat">
      <header class="chat-header">
        <div style="display:flex; align-items:center; gap:10px">
          <div id="activeGroupEmoji" class="pill" aria-hidden="true">üí¨</div>
          <h2 id="activeGroupTitle">Selecionar um grupo‚Ä¶</h2>
        </div>
        <div id="memberCount" class="pill" title="Contagem de membros">üë• 1</div>
      </header>
      <section id="messageList" class="messages" aria-live="polite" aria-label="Mensagens do grupo"></section>
      <footer class="composer">
        <textarea id="messageInput" class="focus-ring" placeholder="Escreva sua mensagem‚Ä¶ (Shift+Enter para nova linha)" aria-label="Mensagem"></textarea>
        <button id="sendBtn" class="btn" title="Enviar (Enter)">Enviar ‚èé</button>
      </footer>
    </main>
  </div>
  <div id="emojiPicker" class="emoji-picker" role="dialog" aria-modal="true" aria-labelledby="emojiPickerTitle">
    <div id="emojiPickerTitle" class="section-title" style="margin:0 4px">Escolha seu emoji</div>
    <input id="emojiSearch" class="emoji-search" placeholder="Filtrar (ex.: sorriso, fogo, gato‚Ä¶)" />
    <div id="emojiGrid" class="emoji-grid" aria-label="Grelha de emojis"></div>
    <div class="emoji-actions">
      <button id="randomEmojiBtn" class="btn secondary">Aleat√≥rio üé≤</button>
      <button id="closeEmojiBtn" class="btn">Concluir</button>
    </div>
  </div>

  <script type="module">
    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, query, orderBy, where, limit, arrayUnion, arrayRemove, deleteDoc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDd-i47C51sseWaMtZbBBdPbObjP1_kYzU",
      authDomain: "minimaltag-28769.firebaseapp.com",
      projectId: "minimaltag-28769",
      storageBucket: "minimaltag-28769.firebasestorage.app",
      messagingSenderId: "645337589970",
      appId: "1:645337589970:web:24be0fabbc3f2b30eaa50b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /***** Estado *****/
    let state = {
      user: null,
      profile: { name: "", avatar: "üôÇ", lastNameChange: null },
      groups: [],
      popularGroups: [],
      messages: {},
      activeGroupId: null
    };

    /***** Util *****/
    const $ = sel => document.querySelector(sel);
    const el = html => {
      const t = document.createElement('template'); t.innerHTML = html.trim();
      return t.content.firstElementChild;
    };
    const defaultEmojis = [
      "üôÇ","üòÄ","üòé","ü§†","ü§ñ","üëª","üê±","üê∂","ü¶ä","üêº","üêß","üê∏","üêµ","ü¶Ñ","üêØ",
      "üå∏","üåø","üî•","‚ö°","‚ú®","üåà","‚òÄÔ∏è","üåô","‚≠ê","‚ùÑÔ∏è","üíß","üçÄ","üçâ","üçï","üç©","üç™",
      "üéß","üéÆ","üé≤","üéØ","üé®","üé∏","üé∑","üé∫","ü•Å","üìö","üíª","üõ∞Ô∏è","üöÄ","üõ∏","üèÑ","üèÄ","‚öΩ"
    ];
    const emojiCatalog = [
      ...defaultEmojis,
      "üòÑ","üòÅ","üòÇ","ü§£","üòä","üòç","üòò","ü§©","üòú","ü§ì","üòå","üò¥","ü§§","üò∑","ü§í","ü§ï",
      "ü§ß","ü•≥","ü§Ø","ü•∂","ü•µ","ü•∫","üòá","üòà","üëΩ","üíÄ","ü§°","üß†","üß∏","ü¶ã","üêù","ü¶ï",
      "üåµ","üåª","üåä","üåã","üåê","üß≠","ü™ê","üí°","üì°","üîí","üß©","üß™","‚öôÔ∏è","üõ†Ô∏è","üß∞","üì∑",
      "üé¨","üé§","üéπ","‚ôüÔ∏è","üßó","üö¥","üèÜ","ü•á","üßÅ","üç´","üçî","üç£","üçú","‚òï","üç∫","üç∑"
    ];
    const adjectives = ["√Ågil","An√¥nimo","Serelepe","Bravo","C√≥smico","Criativo","Calmo","Discreto","El√©trico","Feliz","Gentil","Hiper","√çmpar","Jovial","Lunar","M√≠stico","Nativo","On√≠rico","Pacifico","Qu√¢ntico","Radiante","S√°bio","Tranquilo","√önico","Veloz","Zen"];
    const nouns = ["Gato","Lobo","Coruja","Sapo","Raposa","Arara","Golfinho","Tucano","Panda","Falc√£o","Caramujo","Abelha","Polvo","Unic√≥rnio","Cervo","Capivara","Tamandu√°","Pirilampo","Quati","Boto","On√ßa","Beija-Flor","Jacar√©","Sabi√°","Gavi√£o","Mico"];
    const nowISO = () => new Date().toISOString();
    const nowTimestamp = () => Timestamp.now();
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function randomName(){ return `${pick(adjectives)} ${pick(nouns)}`; }
    function formatTime(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined, { hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit' });
    }
    function escapeHTML(str){
      return str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
    }
    function linkify(str){
      return str.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    }
    function announce(msg){
      let live = document.getElementById('live');
      if(!live){
        live = document.createElement('div');
        live.id = 'live';
        live.className = 'sr-only';
        live.setAttribute('role','status');
        live.setAttribute('aria-live','polite');
        document.body.appendChild(live);
      }
      live.textContent = msg;
    }

    /***** Autentica√ß√£o *****/
    async function initAuth(){
      try {
        await signInAnonymously(auth);
      } catch (error) {
        console.error("Erro na autentica√ß√£o an√¥nima:", error);
        announce("Erro ao conectar com a nuvem. Usando modo local.");
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        state.user = user;
        // Carregar perfil
        const profileRef = doc(db, 'users', user.uid);
        const profileSnap = await getDoc(profileRef);
        if (profileSnap.exists()) {
          state.profile = profileSnap.data();
        } else {
          state.profile = { name: randomName(), avatar: pick(defaultEmojis), lastNameChange: null };
          await setDoc(profileRef, state.profile);
        }
        renderProfile();
        // Carregar grupos e populares
        loadGroups();
        loadPopularGroups();
      } else {
        state.user = null;
        state.profile = { name: randomName(), avatar: pick(defaultEmojis), lastNameChange: null };
        renderProfile();
        announce("Modo offline ativo. Dados salvos localmente.");
      }
    });

    /***** Perfil *****/
    const avatarBtn = $('#avatarBtn');
    const displayName = $('#displayName');
    const randomNameBtn = $('#randomNameBtn');
    const saveProfileBtn = $('#saveProfileBtn');

    async function renderProfile(){
      avatarBtn.textContent = state.profile.avatar || "üôÇ";
      displayName.value = state.profile.name || "";
    }

    async function applyProfileUpdates(newName){
      const now = Date.now();
      const lastChange = state.profile.lastNameChange ? state.profile.lastNameChange.toMillis() : 0;
      if (lastChange && (now - lastChange < 24 * 60 * 60 * 1000)) {
        announce("Voc√™ s√≥ pode mudar o nome a cada 24 horas.");
        return;
      }
      state.profile.name = newName || randomName();
      state.profile.lastNameChange = nowTimestamp();
      if (state.user) {
        const profileRef = doc(db, 'users', state.user.uid);
        await setDoc(profileRef, state.profile);
      }
      renderProfile();
      announce("Perfil salvo.");
    }

    randomNameBtn.addEventListener('click', async () => {
      const newName = randomName();
      displayName.value = newName;
      await applyProfileUpdates(newName);
    });
    saveProfileBtn.addEventListener('click', () => applyProfileUpdates(displayName.value.trim()));
    displayName.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyProfileUpdates(displayName.value.trim());
      }
    });

    /***** Emoji Picker *****/
    const picker = $('#emojiPicker');
    const emojiGrid = $('#emojiGrid');
    const emojiSearch = $('#emojiSearch');
    const randomEmojiBtn = $('#randomEmojiBtn');
    const closeEmojiBtn = $('#closeEmojiBtn');

    function openPicker(){
      buildEmojiGrid();
      picker.style.display = 'block';
      emojiSearch.value = '';
      emojiSearch.focus();
    }
    function closePicker(){ picker.style.display = 'none'; }

    function buildEmojiGrid(filter=""){
      const norm = filter.trim().toLowerCase();
      const set = norm ? emojiCatalog.filter(e => {
        const tags = {
          "gato":["üê±"], "cachorro":["üê∂"], "raposa":["ü¶ä"], "fogo":["üî•"],
          "estrela":["‚≠ê"], "sol":["‚òÄÔ∏è"], "lua":["üåô"], "arco":["üåà"], "raio":["‚ö°"],
          "pc":["üíª"], "jogo":["üéÆ","üé≤"], "musica":["üé∏","üé∑","üé∫","üéπ","üé§"],
          "pizza":["üçï"], "doce":["üç©","üç™","üç´"], "cafe":["‚òï"], "rock":["üé∏"]
        };
        let related = [];
        for(const k in tags){ if(k.includes(norm)) related = related.concat(tags[k]); }
        return related.includes(e) || e.includes(norm);
      }) : emojiCatalog;

      emojiGrid.innerHTML = '';
      set.forEach(em => {
        const b = document.createElement('button');
        b.type = 'button';
        b.setAttribute('aria-label', `Emoji ${em}`);
        b.textContent = em;
        b.addEventListener('click', async () => {
          state.profile.avatar = em;
          if (state.user) {
            const profileRef = doc(db, 'users', state.user.uid);
            await setDoc(profileRef, state.profile);
          }
          renderProfile();
          closePicker();
          announce("Avatar atualizado.");
        });
        emojiGrid.appendChild(b);
      });
    }

    avatarBtn.addEventListener('click', openPicker);
    emojiSearch.addEventListener('input', e => buildEmojiGrid(e.target.value));
    randomEmojiBtn.addEventListener('click', async () => {
      state.profile.avatar = pick(defaultEmojis);
      if (state.user) {
        const profileRef = doc(db, 'users', state.user.uid);
        await setDoc(profileRef, state.profile);
      }
      renderProfile();
      closePicker();
      announce("Avatar aleat√≥rio escolhido.");
    });
    closeEmojiBtn.addEventListener('click', closePicker);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePicker(); });

    /***** Grupos *****/
    const groupList = $('#groupList');
    const popularGroupsList = $('#popularGroups');
    const addGroupBtn = $('#addGroupBtn');
    const groupSearch = $('#groupSearch');

    function loadGroups(){
      if (!state.user) {
        state.groups = [];
        renderGroups();
        return;
      }
      const groupsQuery = query(collection(db, 'groups'), where('members', 'array-contains', state.user.uid));
      return onSnapshot(groupsQuery, (snapshot) => {
        state.groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderGroups();
        if (!state.activeGroupId && state.groups[0]) {
          setActiveGroup(state.groups[0].id);
        }
      });
    }

    function loadPopularGroups(){
      if (!state.user) {
        state.popularGroups = [];
        renderPopularGroups();
        return;
      }
      const popularQuery = query(collection(db, 'groups'), orderBy('memberCount', 'desc'), limit(10));
      return onSnapshot(popularQuery, (snapshot) => {
        state.popularGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderPopularGroups();
      });
    }

    function renderGroups(){
      const q = groupSearch.value.trim().toLowerCase();
      groupList.innerHTML = '';
      const filtered = q ? state.groups.filter(g => g.title.toLowerCase().includes(q)) : state.groups;
      filtered.forEach(g => groupList.appendChild(renderGroupItem(g, true)));
      if (filtered.length === 0) {
        groupList.appendChild(el(`<div class="tip">Nenhum grupo encontrado. Busque grupos globais! ‚ú®</div>`));
      }
    }

    function renderPopularGroups(){
      popularGroupsList.innerHTML = '';
      state.popularGroups.forEach(g => {
        const isMember = g.members.includes(state.user.uid);
        popularGroupsList.appendChild(renderGroupItem(g, isMember));
      });
      if (state.popularGroups.length === 0) {
        popularGroupsList.appendChild(el(`<div class="tip">Nenhum grupo popular ainda.</div>`));
      }
    }

    function renderGroupItem(group, isMember){
      const active = state.activeGroupId === group.id;
      const item = el(`
        <div class="group ${active ? 'active':''}" role="option" aria-selected="${active}">
          <div class="group-emoji">${group.emoji}</div>
          <div class="group-title">${escapeHTML(group.title)} <span style="font-size:12px; color:var(--muted)">(${group.memberCount || 1} membros)</span></div>
          <div class="group-actions">
            ${isMember ? '<button class="icon-btn" title="Renomear" aria-label="Renomear grupo">‚úé</button><button class="icon-btn" title="Remover" aria-label="Remover grupo">üóëÔ∏è</button>' : '<button class="icon-btn join-btn" title="Inscrever-se" aria-label="Inscrever-se no grupo">‚ûï</button>'}
          </div>
        </div>
      `);
      item.addEventListener('click', (e) => {
        if (e.target.closest('.icon-btn')) return;
        setActiveGroup(group.id);
      });
      if (isMember) {
        // Renomear (apenas se criador)
        item.querySelectorAll('.icon-btn')[0].addEventListener('click', async (e) => {
          e.stopPropagation();
          if (group.createdBy !== state.user.uid) {
            announce("Somente o criador pode renomear.");
            return;
          }
          const title = prompt('Novo nome do grupo:', group.title);
          if (title && title.trim()) {
            const groupRef = doc(db, 'groups', group.id);
            await setDoc(groupRef, { title: title.trim(), titleLower: title.trim().toLowerCase() }, { merge: true });
            announce(`Grupo "${title}" renomeado.`);
          }
        });
        // Remover (deixar o grupo)
        item.querySelectorAll('.icon-btn')[1].addEventListener('click', async (e) => {
          e.stopPropagation();
          const ok = confirm(`Deixar o grupo "${group.title}"?`);
          if (!ok) return;
          const groupRef = doc(db, 'groups', group.id);
          await setDoc(groupRef, { members: arrayRemove(state.user.uid), memberCount: group.memberCount - 1 }, { merge: true });
          if (state.activeGroupId === group.id) {
            state.activeGroupId = state.groups[0]?.id || null;
            renderChatHeader();
            renderMessages();
          }
          announce(`Voc√™ deixou o grupo "${group.title}".`);
        });
      } else {
        // Join
        item.querySelector('.join-btn').addEventListener('click', async (e) => {
          e.stopPropagation();
          const groupRef = doc(db, 'groups', group.id);
          await setDoc(groupRef, { members: arrayUnion(state.user.uid), memberCount: (group.memberCount || 0) + 1 }, { merge: true });
          setActiveGroup(group.id);
          announce(`Voc√™ se inscreveu no grupo "${group.title}".`);
        });
      }
      return item;
    }

    async function createGroup(){
      const title = prompt('Nome do grupo/tema:', '');
      if (!title || !title.trim()) return;
      const g = {
        title: title.trim(),
        titleLower: title.trim().toLowerCase(),
        emoji: pick(["üí¨","üî•","üéÆ","üéß","üì∞","üé®","üß†","üìö","üíª","üèà","‚öΩ","üé¨","üç≥","üåç","üß™","üöÄ","üßò","üé≤","üé≠","üé§"]),
        createdBy: state.user.uid,
        createdAt: nowTimestamp(),
        members: [state.user.uid],
        memberCount: 1
      };
      const groupRef = doc(collection(db, 'groups'));
      await setDoc(groupRef, g);
      state.activeGroupId = groupRef.id;
      announce(`Grupo "${g.title}" criado e voc√™ est√° inscrito.`);
    }

    function setActiveGroup(id){
      state.activeGroupId = id;
      renderGroups();
      renderPopularGroups();
      renderChatHeader();
      loadMessages(id);
      renderMessages();
    }

    addGroupBtn.addEventListener('click', createGroup);
    groupSearch.addEventListener('input', () => {
      renderGroups();
      searchGlobalGroups();
    });

    async function searchGlobalGroups(){
      const q = groupSearch.value.trim().toLowerCase();
      if (!q) return;
      const globalQuery = query(collection(db, 'groups'), where('titleLower', '>=', q), where('titleLower', '<=', q + '\uf8ff'), limit(10));
      const snapshot = await getDocs(globalQuery);
      const searchedGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Adicionar √† lista de grupos se n√£o estiverem
      searchedGroups.forEach(g => {
        if (!state.groups.find(gg => gg.id === g.id)) {
          groupList.appendChild(renderGroupItem(g, false));
        }
      });
    }

    /***** Chat *****/
    const messageList = $('#messageList');
    const messageInput = $('#messageInput');
    const sendBtn = $('#sendBtn');
    const activeGroupTitle = $('#activeGroupTitle');
    const activeGroupEmoji = $('#activeGroupEmoji');
    const memberCount = $('#memberCount');

    function currentGroup(){
      return state.groups.find(g => g.id === state.activeGroupId) || state.popularGroups.find(g => g.id === state.activeGroupId) || null;
    }

    function renderChatHeader(){
      const g = currentGroup();
      if (!g) {
        activeGroupTitle.textContent = "Selecionar um grupo‚Ä¶";
        activeGroupEmoji.textContent = "üí¨";
        memberCount.textContent = "üë• 1";
        return;
      }
      activeGroupTitle.textContent = g.title;
      activeGroupEmoji.textContent = g.emoji;
      memberCount.textContent = `üë• ${g.memberCount || 1}`;
    }

    function renderMessages(){
      const g = currentGroup();
      messageList.innerHTML = '';
      if (!g) {
        messageList.appendChild(el(`<div class="tip">Crie ou selecione um grupo para come√ßar.</div>`));
        return;
      }
      const messages = state.messages[g.id] || [];
      messages.forEach(m => messageList.appendChild(renderMessage(m)));
      messageList.scrollTop = messageList.scrollHeight;
    }

    function renderMessage(m){
      const node = el(`
        <article class="msg">
          <div class="a" aria-hidden="true">${m.avatar}</div>
          <div class="bubble">
            <div class="meta">
              <strong>${escapeHTML(m.author)}</strong>
              <span>${formatTime(m.time instanceof Timestamp ? m.time.toDate() : m.time)}</span>
            </div>
            <div class="text">${linkify(escapeHTML(m.text))}</div>
          </div>
        </article>
      `);
      return node;
    }

    async function sendMessage(){
      const g = currentGroup();
      if (!g) {
        announce("Selecione um grupo antes de enviar.");
        return;
      }
      const text = messageInput.value.replace(/\s+$/,'');
      if (!text.trim()) return;

      const msg = {
        author: state.profile.name?.trim() || randomName(),
        avatar: state.profile.avatar || "üôÇ",
        text,
        time: nowTimestamp()
      };
      if (state.user) {
        const messagesRef = collection(db, 'groups', g.id, 'messages');
        await addDoc(messagesRef, msg);
      }
      // Adicionar localmente para renderiza√ß√£o imediata
      state.messages[g.id] = state.messages[g.id] || [];
      state.messages[g.id].push(msg);
      renderMessages();
      messageInput.value = '';
      messageInput.style.height = 'auto';
      messageInput.focus();
    }

    function loadMessages(groupId){
      if (!state.user || !groupId) {
        state.messages[groupId] = [];
        renderMessages();
        return;
      }
      const twentyFourHoursAgo = Timestamp.fromMillis(Date.now() - 24 * 60 * 60 * 1000);
      const messagesQuery = query(collection(db, 'groups', groupId, 'messages'), where('time', '>', twentyFourHoursAgo), orderBy('time', 'asc'));
      return onSnapshot(messagesQuery, async (snapshot) => {
        state.messages[groupId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // Deletar mensagens antigas
        const oldMessagesQuery = query(collection(db, 'groups', groupId, 'messages'), where('time', '<=', twentyFourHoursAgo));
        const oldSnapshot = await getDocs(oldMessagesQuery);
        oldSnapshot.forEach(async (doc) => await deleteDoc(doc.ref));
        if (state.activeGroupId === groupId) {
          renderMessages();
        }
      });
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    messageInput.addEventListener('input', autosize);

    function autosize(){
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 160) + 'px';
    }

    /***** Inicializa√ß√£o *****/
    async function bootstrap(){
      await initAuth();
    }

    bootstrap();
  </script>
</body>
</html>